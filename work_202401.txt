Fix bug in authentication
Add tests
