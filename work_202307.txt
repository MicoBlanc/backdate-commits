Fix bug in authentication
Clean up code
