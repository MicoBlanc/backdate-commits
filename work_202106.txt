Refactor database queries
Fix edge case
